# =============================================================================
# Raspberry Pi 5 MCC Integration Test Rack A
# =============================================================================
#
# Hardware stack (verified 2025-02-02):
#   - Raspberry Pi 5
#   - MCC 152 at address 0 - Digital I/O + Analog Out
#   - MCC 134 at address 1 - Thermocouple DAQ
#   - MCC 118 at address 4 - Voltage DAQ
#   - Waveshare RS485 CAN HAT B (modified for CE1) - CAN bus
#
# SPI allocation:
#   - spi0.0 (CE0): MCC HATs (shared via address lines GPIO12/13/26)
#   - spi0.1 (CE1): CAN HAT (MCP2515)
#
# =============================================================================

rack:
  id: "pi5-mcc-intg-a"
  description: "Raspberry Pi 5 MCC DAQ integration test rack with CAN bus"

# =============================================================================
# Calibration Factors
# =============================================================================
#
# These factors correct for hardware-specific scaling in the signal path.
# Measure and update these when changing wiring or hardware.
#
# To measure MCC 118 scale factor:
#   1. Apply known voltage (e.g., 2.5V from calibrated source)
#   2. Read raw value from MCC 118
#   3. scale_factor = actual_voltage / raw_reading
#
# UUT calibration is included here because the UUT hardware is known
# for this integration test setup (Pi 4 with Waveshare High-Precision AD/DA).

calibration:
  # UUT ADC has 2:1 voltage divider (Waveshare High-Precision AD/DA board)
  # Raw reading must be multiplied by 2 to get actual input voltage
  uut_adc_scale_factor: 2.0

  # MCC 118 input attenuation due to wiring/protection circuitry
  # Raw reading must be multiplied by this to get actual voltage
  mcc118_scale_factor: 1.5

# =============================================================================
# Instruments
# =============================================================================

instruments:
  dio_controller:
    driver: "hwtest_mcc.mcc152:create_instrument"
    identity:
      manufacturer: "Measurement Computing"
      model: "MCC 152"
    kwargs:
      address: 0
      source_id: "dio_controller"
      dio_channels:
        - id: 0
          name: "relay_dut_power"
          direction: "OUTPUT"
          initial_value: false
        - id: 1
          name: "relay_load"
          direction: "OUTPUT"
          initial_value: false
        - id: 2
          name: "sensor_door"
          direction: "INPUT"
        - id: 3
          name: "sensor_estop"
          direction: "INPUT"
        - id: 4
          name: "gpio_4"
          direction: "INPUT"
        - id: 5
          name: "gpio_5"
          direction: "INPUT"
        - id: 6
          name: "gpio_6"
          direction: "INPUT"
        - id: 7
          name: "gpio_7"
          direction: "INPUT"
      analog_channels:
        - id: 0
          name: "rack_dac"
          description: "Voltage output to UUT"
          initial_voltage: 0.0
        - id: 1
          name: "reference_voltage"
          description: "Reference voltage output"
          initial_voltage: 2.5

  thermocouple_daq:
    driver: "hwtest_mcc.mcc134:create_instrument"
    identity:
      manufacturer: "Measurement Computing"
      model: "MCC 134"
    kwargs:
      address: 1
      source_id: "thermocouple_daq"
      update_interval: 1.0
      channels:
        - id: 0
          name: "tc_0"
          tc_type: "TYPE_K"
        - id: 1
          name: "tc_1"
          tc_type: "TYPE_K"
        - id: 2
          name: "tc_2"
          tc_type: "TYPE_K"
        - id: 3
          name: "tc_3"
          tc_type: "TYPE_K"

  voltage_daq:
    driver: "hwtest_mcc.mcc118:create_instrument"
    identity:
      manufacturer: "Measurement Computing"
      model: "MCC 118"
    kwargs:
      address: 4
      sample_rate: 1000.0
      source_id: "voltage_daq"
      channels:
        - id: 0
          name: "rack_adc"
          description: "Echo voltage measurement from UUT"
        - id: 1
          name: "voltage_1"
        - id: 2
          name: "voltage_2"
        - id: 3
          name: "voltage_3"
        - id: 4
          name: "voltage_4"
        - id: 5
          name: "voltage_5"
        - id: 6
          name: "voltage_6"
        - id: 7
          name: "voltage_7"

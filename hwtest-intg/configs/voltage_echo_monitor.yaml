# =============================================================================
# Voltage Echo Monitor Test Definition
# =============================================================================
#
# This file defines the parameters, states, and monitors for the voltage
# echo monitor test. It is the source of truth for test configuration and
# should be reviewed by the team (managers, EEs, test developers) when
# requirements change.
#
# Changes to this file do not require Python code review - they only affect
# test parameters.
#
# Hardware Setup:
#   Test Rack (Pi 5):     MCC 152 DAC → ... → MCC 118 ADC
#   UUT Simulator (Pi 4): ADS1256 ADC → DAC8532 DAC
#
# Signal Path:
#   MCC 152 Analog Out 0 → UUT ADS1256 Channel 0 → UUT DAC8532 Channel 0 → MCC 118 Channel 0
#
# =============================================================================

test_case:
  id: voltage_echo_monitor
  name: Voltage Echo Monitor Test
  version: "1.1.0"
  description: |
    Tests analog voltage echo loop through UUT ADC/DAC with state-based monitoring.
    The test rack outputs a target voltage, the UUT reads and echoes it back,
    and the test rack verifies the returned voltage is within tolerance.

# =============================================================================
# Rack Reference
# =============================================================================
#
# The test rack configuration that this test case is designed to run on.
# Override with RACK_CONFIG environment variable if running on a different rack.

rack: pi5_mcc_intg_a_rack

# =============================================================================
# Case Parameters
# =============================================================================
#
# Global parameters that apply to all states unless overridden per-state.

case_parameters:
  # Time to wait after voltage changes for signals to settle
  settling_time_seconds: 0.025  # 25ms allows ~10 Hz with HTTP overhead

# =============================================================================
# Monitor States
# =============================================================================
#
# Environmental states that define test conditions. Each state can override
# case_parameters. States are executed in the order listed in state_sequence.
#
# Reserved state names: 'default' (fallback bounds), 'any' (skip checking)

monitor_states:
  minimum:
    name: Minimum Voltage
    description: Lowest voltage in the test range
    target_voltage: 1.0  # V

  middle:
    name: Middle Voltage
    description: Mid-point voltage in the test range
    target_voltage: 2.5  # V

  maximum:
    name: Maximum Voltage
    description: Highest voltage in the test range
    target_voltage: 4.0  # V

# =============================================================================
# State Sequence
# =============================================================================
#
# Order in which states are executed during each test cycle.
# In HALT/HASS mode, this sequence repeats until failure or cancellation.

state_sequence:
  - minimum
  - middle
  - maximum

# =============================================================================
# Monitors
# =============================================================================
#
# Monitors continuously check measurement values against state-dependent bounds.
# Each monitor specifies:
#   - module/class: Python module and class for dynamic loading
#   - kwargs: Arguments passed to monitor constructor
#   - configuration: Bounds per field, per state
#
# Bound types:
#   within_range: [center, tolerance]  - value within center ± tolerance
#   good_interval: [low, high]         - value within [low, high]
#   less_than: value                   - value < threshold
#   greater_than: value                - value > threshold
#   good_values: [list]                - value in discrete set
#   special: any                       - always pass (no check)
#
# Monitor error classification:
#   kwargs:    - System monitor (errors indicate test system failure)
#   kwargs.N:  - UUT monitor for slot N (errors indicate UUT failure)

monitors:
  echo_voltage_monitor:
    module: hwtest_testcase
    class: Monitor
    # UUT monitor for slot 0 - failures indicate the UUT is bad
    kwargs.0:
      channel: echo_voltage
    configuration:
      # Default bounds if a state doesn't specify (use 'special: any' to skip)
      default:
        echo_voltage:
          special: any  # Must specify per state

      # Per-state bounds
      minimum:
        echo_voltage:
          within_range: [1.0, 0.30]  # 1.0V ± 0.30V

      middle:
        echo_voltage:
          within_range: [2.5, 0.30]  # 2.5V ± 0.30V

      maximum:
        echo_voltage:
          within_range: [4.0, 0.30]  # 4.0V ± 0.30V

# =============================================================================
# Loggers
# =============================================================================
#
# Loggers record telemetry data to various backends. Unlike monitors, loggers
# do not have slot-specific configurations since they capture system-wide
# telemetry rather than per-UUT data.
#
# Each logger specifies:
#   - module/class: Python module and class for dynamic loading
#   - kwargs: Arguments passed to logger constructor
#   - topics: List of topics this logger should subscribe to
#   - enabled: Whether this logger is active (default: true)
#   - ignore_offsite: If true, logger is skipped when OFFSITE_MODE=1

loggers:
  # InfluxDB logger for real-time telemetry visualization
  # Skipped in offsite mode since it requires network connectivity
  influxdb_logger:
    module: hwtest_logger
    class: InfluxDbStreamLogger
    ignore_offsite: true
    kwargs:
      url: "${INFLUXDB_URL:http://localhost:8086}"
      org: "${INFLUXDB_ORG:hwtest}"
      bucket: "${INFLUXDB_BUCKET:telemetry}"
      token: "${INFLUXDB_TOKEN}"
      measurement: voltage_echo
      batch_size: 100
      flush_interval_ms: 1000
    topics:
      - voltage_echo

  # CSV logger for local file storage
  # Works in offsite mode - data can be imported to InfluxDB later via:
  #   hwtest-import-csv /path/to/logs --url http://influx:8086 --token <token>
  # Directory structure: {output_dir}/{test_type}/{test_case_id}/{test_run_id}/
  csv_logger:
    module: hwtest_logger
    class: CsvStreamLogger
    kwargs:
      output_dir: "${CSV_LOG_DIR:./logs}"
      organize_by_tags: true
      buffer_size: 100
    topics:
      - voltage_echo

# =============================================================================
# Functional Requirements (optional)
# =============================================================================
#
# Point-in-time checks performed at specific moments (e.g., initialization).
# Unlike monitors, these are not continuously evaluated.
#
# functional_requirements:
#   initial_voltage_check:
#     default:
#       rack_dac_voltage:
#         good_interval: [0.0, 0.1]  # Should be near zero at start
